name: Build And Test On Ubuntu 2204
on:
  push:
    branches:
      - master
      - main

jobs:
  build-and-test-on-ubuntu-2204-with-gcc:
    name: "ubuntu-22.04-${{ matrix.compiler }}-${{ matrix.version }}-${{ matrix.build_type }}"
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # Installed by github images
          # Details: https://github.com/actions/runner-images
          - { compiler: "gcc",   version: "11.4.0", build_type: Debug,   cxxflags: "" }
          - { compiler: "gcc",   version: "11.4.0", build_type: Release, cxxflags: "" }
          - { compiler: "gcc",   version: "12.3.0", build_type: Release, cxxflags: "" }
          - { compiler: "clang", version: "13.0.1", build_type: Release, cxxflags: "" }
          - { compiler: "clang", version: "14.0.0", build_type: Release, cxxflags: "" }
          - { compiler: "clang", version: "15.0.7", build_type: Release, cxxflags: "" }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup C/C++ compiler
        run: |
          if [[ "${{ matrix.version }}" == "x.x.x" ]]; then
            echo "Install a specific compiler version."
          fi

          major=$(echo ${{ matrix.version }} | cut -d'.' -f1)
          if [[ "${{ matrix.compiler }}" == "clang" ]]; then
            echo "CC=clang-${major}" >> ${GITHUB_ENV}
            echo "CXX=clang++-${major}" >> ${GITHUB_ENV}
          else
            echo "CC=gcc-${major}" >> ${GITHUB_ENV}
            echo "CXX=g++-${major}" >> ${GITHUB_ENV}
          fi
          echo "${CC}, ${CXX}"

      - name: Install other dependencies
        run: |
          sudo apt install ninja-build;

      - name: Cmake
        run: |
          set -ex;
          cmake -S . -B build -GNinja \
            -DCMAKE_CXX_FLAGS="${{ matrix.cxxflags }}" \
            -DCMAKE_BUILD_TYPE="${{ matrix.build_type }}";

      - name: Compile
        run: |
          cmake --build build -v

      - name: Run unittests
        run: |
          ./build/main;

